<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contatos - WhatsApp CRM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/modern-dashboard.css">
    <link rel="stylesheet" href="css/menu-animations.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .contact-row {
            transition: background-color 0.2s;
        }
        .contact-row:hover {
            background-color: #f8f9fa;
        }
        .contact-row.selected {
            background-color: #e7f5ff;
        }
        .batch-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
        .pagination .page-link {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <!-- Top Bar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-brand">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp CRM</span>
                </a>
            </div>
            <nav class="sidebar-menu">
                <h3>Menu Principal</h3>
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#whatsappSubmenu" class="nav-link dropdown-toggle" data-bs-toggle="collapse" aria-expanded="false">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                    <span class="badge bg-primary badge-menu">2</span>
                </a>
                <div class="submenu collapse" id="whatsappSubmenu">
                    <a href="connect-whatsapp.html" class="nav-link">
                        <i class="fas fa-plug"></i>
                        <span>Conectar WhatsApp</span>
                    </a>
                    <a href="whatsapp-sessions.html" class="nav-link">
                        <i class="fas fa-list"></i>
                        <span>Sessões</span>
                    </a>
                </div>
                <a href="conversas.html" class="nav-link">
                    <i class="fas fa-comments"></i>
                    <span>Conversas</span>
                    <span class="badge bg-success badge-menu">5</span>
                </a>
                <a href="kanban.html" class="nav-link">
                    <i class="fas fa-tasks"></i>
                    <span>Funil de Vendas</span>
                </a>
                <a href="quick-messages.html" class="nav-link">
                    <i class="fas fa-bolt"></i>
                    <span>Mensagens Rápidas</span>
                </a>
                <a href="bulk-messages.html" class="nav-link">
                    <i class="fas fa-paper-plane"></i>
                    <span>Disparo em Massa</span>
                </a>
                <a href="extract-contacts.html" class="nav-link">
                    <i class="fas fa-search-plus"></i>
                    <span>Extrair Contatos</span>
                </a>
                <a href="contacts.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Contatos</span>
                </a>
                <a href="agents.html" class="nav-link">
                    <i class="fas fa-user-tie"></i>
                    <span>Agentes</span>
                </a>
                <h3>Ferramentas</h3>
                <a href="campaigns.html" class="nav-link">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campanhas</span>
                </a>
                <a href="templates.html" class="nav-link">
                    <i class="fas fa-file-alt"></i>
                    <span>Modelos</span>
                </a>
                <a href="import-export.html" class="nav-link">
                    <i class="fas fa-file-import"></i>
                    <span>Importar/Exportar</span>
                </a>
                <h3>Configurações</h3>
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
                <a href="profile.html" class="nav-link">
                    <i class="fas fa-user"></i>
                    <span>Meu Perfil</span>
                </a>
                <a href="#" class="nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </a>
            </nav>
        </div>
        <nav class="top-navbar">
            <button class="menu-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="user-menu">
                <div class="user-info">
                    <p class="user-name">João Silva</p>
                    <p class="user-role">Administrador</p>
                </div>
                <div class="user-avatar">
                    <img src="https://ui-avatars.com/api/?name=Joao+Silva&background=25D366&color=fff" alt="User Avatar">
                </div>
            </div>
        </nav>
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-arrow-left me-2"></i>WhatsApp CRM
                </a>
                <div class="d-flex align-items-center">
                    <a href="agents.html" class="btn btn-outline-primary btn-sm me-3" title="Gerenciar Agentes">
                        <i class="fas fa-user-tie me-1"></i> Agentes
                    </a>
                    <span class="fw-bold me-3">Contatos</span>
                    <button class="btn btn-success" id="newContactBtn">
                        <i class="fas fa-plus me-1"></i> Novo
                    </button>
                </div>
            </div>
        </nav>

        <!-- Filtros e Ações -->
        <div class="container-fluid py-3 border-bottom">
            <div class="row g-2">
                <div class="col-md-5">
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nome ou telefone...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterStatus">
                        <option value="">Todos os tipos</option>
                        <option value="cliente">Clientes</option>
                        <option value="lead">Leads</option>
                        <option value="fornecedor">Fornecedores</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterSource">
                        <option value="">Todas as fontes</option>
                        <option value="google">Google</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="manual">Manual</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortBy">
                        <option value="name_asc">Nome (A-Z)</option>
                        <option value="name_desc">Nome (Z-A)</option>
                        <option value="recent">Recentes</option>
                        <option value="oldest">Antigos</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex">
                    <button class="btn btn-outline-secondary w-100 me-1" id="importBtn" data-bs-toggle="modal" data-bs-target="#importModal">
                        <i class="fas fa-file-import me-1"></i>Importar
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" id="syncGoogleBtn" title="Sincronizar com Google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button class="btn btn-outline-success" id="syncWhatsAppBtn" title="Sincronizar com WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Selecionar todos
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Contatos -->
        <div class="list-group list-group-flush" id="contactsList">
            <!-- Contatos serão carregados aqui -->
        </div>

        <!-- Paginação -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Paginação será gerada aqui -->
            </ul>
        </nav>

        <!-- Ações em Lote -->
        <div class="batch-actions" id="batchActions">
            <div class="btn-group shadow">
                <button class="btn btn-success" id="sendBulkWhatsApp" title="Enviar mensagem">
                    <i class="fab fa-whatsapp me-1"></i> Enviar (<span id="selectedCount">0</span>)
                </button>
                <button class="btn btn-outline-danger" id="deleteSelected" title="Excluir selecionados">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Contato -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Contato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" id="contactName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="contactPhone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="contactEmail">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Modal Importar CSV -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Importar Contatos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Selecione o arquivo CSV</label>
                        <input class="form-control" type="file" id="csvFile" accept=".csv">
                        <div class="form-text">Formato esperado: Nome, Telefone, E-mail (opcional)</div>
                    </div>
                    <div class="progress mb-3" style="display: none;" id="importProgress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="startImport">Importar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Configurações
    const CSV_HEADERS = ['nome', 'telefone', 'email'];
    let fileReader = new FileReader();
    
    // Funções auxiliares para formatação
    function formatSource(source) {
        const sources = {
            'google': 'Google',
            'whatsapp': 'WhatsApp',
            'manual': 'Manual',
            'csv': 'CSV'
        };
        return sources[source] || source;
    }
    
    function formatType(type) {
        const types = {
            'cliente': 'Cliente',
            'lead': 'Lead',
            'fornecedor': 'Fornecedor'
        };
        return types[type] || type;
    }
    
    function getSourceBadgeColor(source) {
        const colors = {
            'google': 'danger',
            'whatsapp': 'success',
            'manual': 'primary',
            'csv': 'info'
        };
        return colors[source] || 'secondary';
    }
    
    function getTypeBadgeColor(type) {
        const colors = {
            'cliente': 'primary',
            'lead': 'warning',
            'fornecedor': 'info'
        };
        return colors[type] || 'secondary';
    }
    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let selectedContacts = new Set();
    let allContacts = [
        {id: 1, name: 'João Silva', phone: '11999998888', email: 'joao@exemplo.com', type: 'cliente', createdAt: '2025-01-15'},
        {id: 2, name: 'Maria Santos', phone: '21999997777', email: 'maria@exemplo.com', type: 'lead', createdAt: '2025-02-20'},
        {id: 3, name: 'Carlos Oliveira', phone: '11999996666', email: 'carlos@exemplo.com', type: 'fornecedor', createdAt: '2025-03-10'},
        {id: 4, name: 'Ana Paula', phone: '11999995555', email: 'ana@exemplo.com', type: 'cliente', createdAt: '2025-04-05'},
        {id: 5, name: 'Pedro Henrique', phone: '11999994444', email: 'pedro@exemplo.com', type: 'lead', createdAt: '2025-05-01'},
        {id: 6, name: 'Fernanda Lima', phone: '11999993333', email: 'fernanda@exemplo.com', type: 'cliente', createdAt: '2025-05-10'},
        {id: 7, name: 'Ricardo Almeida', phone: '11999992222', email: 'ricardo@exemplo.com', type: 'fornecedor', createdAt: '2025-05-15'},
    ];
    let contacts = [...allContacts];

    // Configura o leitor de arquivos
    fileReader.onload = function(event) {
        const csvData = event.target.result;
        processCSVData(csvData);
    };
    
    fileReader.onerror = function() {
        alert('Erro ao ler o arquivo. Por favor, tente novamente.');
        document.getElementById('importProgress').style.display = 'none';
    };
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // Configura o botão de importação
        document.getElementById('startImport').addEventListener('click', function() {
            const fileInput = document.getElementById('csvFile');
            if (fileInput.files.length === 0) {
                alert('Por favor, selecione um arquivo CSV.');
                return;
            }
            
            const progress = document.getElementById('importProgress');
            progress.style.display = 'block';
            progress.querySelector('.progress-bar').style.width = '0%';
            
            // Lê o arquivo CSV
            fileReader.readAsText(fileInput.files[0]);
        });
        loadContacts();
        
        // Event Listeners
        document.getElementById('newContactBtn').addEventListener('click', showContactModal);
        document.getElementById('contactForm').addEventListener('submit', saveContact);
        document.getElementById('searchInput').addEventListener('input', filterContacts);
        document.getElementById('filterStatus').addEventListener('change', filterContacts);
        document.getElementById('sortBy').addEventListener('change', filterContacts);
        document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
        document.getElementById('sendBulkWhatsApp').addEventListener('click', sendBulkWhatsApp);
        document.getElementById('deleteSelected').addEventListener('click', deleteSelectedContacts);
        document.getElementById('syncGoogleBtn').addEventListener('click', syncGoogleContacts);
        document.getElementById('syncWhatsAppBtn').addEventListener('click', syncWhatsAppContacts);
        document.getElementById('filterSource').addEventListener('change', filterContacts);
        
        // Inicializa o modal de importação
        const importModal = document.getElementById('importModal');
        if (importModal) {
            importModal.addEventListener('shown.bs.modal', function() {
                document.getElementById('csvFile').value = '';
            });
        }
    });

    function loadContacts() {
        const container = document.getElementById('contactsList');
        container.innerHTML = '';
        
        // Ordena os contatos
        sortContacts();
        
        // Atualiza a paginação
        updatePagination();
        
        // Filtra os contatos para a página atual
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const paginatedContacts = contacts.slice(start, end);
        
        if (paginatedContacts.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted">Nenhum contato encontrado</div>';
            updateBatchActions();
            return;
        }

        paginatedContacts.forEach(contact => {
            const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            const isSelected = selectedContacts.has(contact.id);
            
            const item = document.createElement('div');
            item.className = `list-group-item list-group-item-action contact-row ${isSelected ? 'selected' : ''}`;
            item.setAttribute('data-contact-id', contact.id);
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="form-check me-2">
                        <input class="form-check-input contact-check" type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               data-contact-id="${contact.id}">
                    </div>
                    <div class="contact-avatar me-3">${initials}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0 me-2">${contact.name}</h6>
                            ${contact.source ? `<span class="badge bg-${getSourceBadgeColor(contact.source)} mb-1">${formatSource(contact.source)}</span>` : ''}
                            ${contact.type ? `<span class="badge bg-${getTypeBadgeColor(contact.type)} ms-1 mb-1">${formatType(contact.type)}</span>` : ''}
                        </div>
                        <small class="text-muted d-block">${contact.phone}</small>
                        ${contact.email ? `<div class="small text-truncate" style="max-width: 200px;">${contact.email}</div>` : ''}
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-link text-muted" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="sendWhatsApp('${contact.phone}')">
                                <i class="fab fa-whatsapp text-success me-2"></i>Enviar mensagem
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="editContact(${contact.id})">
                                <i class="fas fa-edit text-primary me-2"></i>Editar
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteContact(${contact.id})">
                                <i class="fas fa-trash me-2"></i>Excluir
                            </a></li>
                        </ul>
                    </div>
                </div>`;
            
            container.appendChild(item);
        });
        
        // Adiciona eventos aos checkboxes
        document.querySelectorAll('.contact-check').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const contactId = parseInt(this.getAttribute('data-contact-id'));
                if (this.checked) {
                    selectedContacts.add(contactId);
                } else {
                    selectedContacts.delete(contactId);
                    document.getElementById('selectAll').checked = false;
                }
                updateContactRowStyle(contactId, this.checked);
                updateBatchActions();
            });
        });
        
        updateBatchActions();
    }

    function sortContacts() {
        const sortBy = document.getElementById('sortBy').value;
        
        contacts.sort((a, b) => {
            switch(sortBy) {
                case 'name_asc':
                    return a.name.localeCompare(b.name);
                case 'name_desc':
                    return b.name.localeCompare(a.name);
                case 'recent':
                    return new Date(b.createdAt) - new Date(a.createdAt);
                case 'oldest':
                    return new Date(a.createdAt) - new Date(b.createdAt);
                default:
                    return 0;
            }
        });
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(contacts.length / ITEMS_PER_PAGE);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let html = `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>`;
        
        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>`;
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Próximo">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>`;
        
        pagination.innerHTML = html;
        
        // Adiciona eventos de clique para a paginação
        document.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    loadContacts();
                    window.scrollTo(0, 0);
                }
            });
        });
    }
    
    function toggleSelectAll() {
        const isChecked = document.getElementById('selectAll').checked;
        const checkboxes = document.querySelectorAll('.contact-check');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const contactId = parseInt(checkbox.getAttribute('data-contact-id'));
            
            if (isChecked) {
                selectedContacts.add(contactId);
            } else {
                selectedContacts.delete(contactId);
            }
            
            updateContactRowStyle(contactId, isChecked);
        });
        
        updateBatchActions();
    }
    
    function updateContactRowStyle(contactId, isSelected) {
        const row = document.querySelector(`[data-contact-id="${contactId}"]`);
        if (row) {
            if (isSelected) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    }
    
    function updateBatchActions() {
        const batchActions = document.getElementById('batchActions');
        const selectedCount = selectedContacts.size;
        
        if (selectedCount > 0) {
            document.getElementById('selectedCount').textContent = selectedCount;
            batchActions.style.display = 'block';
        } else {
            batchActions.style.display = 'none';
        }
    }
    
    function filterContacts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filterType = document.getElementById('filterStatus').value;
        const filterSource = document.getElementById('filterSource').value;
        
        contacts = allContacts.filter(contact => {
            const matchesSearch = contact.name.toLowerCase().includes(searchTerm) || 
                               contact.phone.includes(searchTerm) ||
                               (contact.email && contact.email.toLowerCase().includes(searchTerm));
            const matchesType = !filterType || contact.type === filterType;
            const matchesSource = !filterSource || contact.source === filterSource;
            return matchesSearch && matchesType && matchesSource;
        });
        
        currentPage = 1; // Volta para a primeira página ao filtrar
        loadContacts();
    }

    function sendBulkWhatsApp() {
        if (selectedContacts.size === 0) return;
        
        // Abre o WhatsApp Web com o primeiro contato
        const firstContact = allContacts.find(c => c.id === Array.from(selectedContacts)[0]);
        if (firstContact) {
            sendWhatsApp(firstContact.phone);
        }
        
        // Para os demais contatos, abre em novas abas
        if (selectedContacts.size > 1) {
            const otherContacts = Array.from(selectedContacts).slice(1);
            otherContacts.forEach(id => {
                const contact = allContacts.find(c => c.id === id);
                if (contact) {
                    setTimeout(() => {
                        window.open(`https://wa.me/55${contact.phone.replace(/\D/g, '')}`, '_blank');
                    }, 1000); // Atraso para evitar bloqueio do navegador
                }
            });
        }
    }
    
    function deleteSelectedContacts() {
        if (selectedContacts.size === 0) return;
        
        if (confirm(`Tem certeza que deseja excluir ${selectedContacts.size} contato(s) selecionado(s)?`)) {
            allContacts = allContacts.filter(contact => !selectedContacts.has(contact.id));
            contacts = [...allContacts];
            selectedContacts.clear();
            filterContacts();
        }
    }

    function showContactModal() {
        document.getElementById('contactForm').reset();
        const modal = new bootstrap.Modal(document.getElementById('contactModal'));
        modal.show();
    }

    function saveContact(e) {
        e.preventDefault();
        
        const name = document.getElementById('contactName').value.trim();
        const phone = document.getElementById('contactPhone').value.trim();
        const email = document.getElementById('contactEmail').value.trim();
        
        // Aqui você adicionaria a lógica para salvar no backend
        alert(`Contato salvo com sucesso!\nNome: ${name}\nTelefone: ${phone}\nE-mail: ${email}`);
        
        // Fechar o modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
        modal.hide();
    }

    function editContact(id) {
        const contact = contacts.find(c => c.id === id);
        if (!contact) return;
        
        document.getElementById('contactName').value = contact.name;
        document.getElementById('contactPhone').value = contact.phone;
        document.getElementById('contactEmail').value = contact.email || '';
        
        const modal = new bootstrap.Modal(document.getElementById('contactModal'));
        modal.show();
    }

    function deleteContact(id) {
        if (confirm('Tem certeza que deseja excluir este contato?')) {
            // Aqui você adicionaria a lógica para excluir no backend
            contacts = contacts.filter(c => c.id !== id);
            loadContacts();
            alert('Contato excluído com sucesso!');
        }
    }

    function sendWhatsApp(phone) {
        // Remove caracteres não numéricos
        const cleanPhone = phone.replace(/\D/g, '');
        // Abre o WhatsApp Web com o número
        window.open(`https://wa.me/55${cleanPhone}`, '_blank');
    }

    function syncGoogleContacts() {
        // Substitua com suas credenciais reais do Google Cloud Console
        const clientId = 'SEU_CLIENT_ID_GOOGLE';
        const clientSecret = 'SUA_CHAVE_SECRETA_CLIENTE';
        const redirectUri = window.location.origin + window.location.pathname;
        const scope = 'https://www.googleapis.com/auth/contacts.readonly';
        
        // Verifica se já temos um token de acesso
        const accessToken = localStorage.getItem('google_access_token');
        if (accessToken) {
            // Se já tivermos token, tenta buscar os contatos diretamente
            fetchGoogleContacts(accessToken);
            return;
        }
        
        // Se não tiver token, inicia o fluxo de autenticação
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                       `client_id=${encodeURIComponent(clientId)}` +
                       `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                       `&response_type=code` +
                       `&scope=${encodeURIComponent(scope)}` +
                       `&access_type=offline` +
                       `&prompt=consent`;
        
        // Abre a janela de autenticação
        const width = 600;
        const height = 600;
        const left = (window.innerWidth - width) / 2;
        const top = (window.innerHeight - height) / 2;
        
        const authWindow = window.open(authUrl, 'googleAuth', 
                   `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`);
        
        // Verifica se a janela foi bloqueada
        if (!authWindow) {
            alert('Por favor, permita pop-ups para este site para continuar com a autenticação.');
        }
    }
    
    // Função para processar o código de autorização retornado pelo Google
    async function processGoogleAuth() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        
        if (code) {
            try {
                // Remove o código da URL sem recarregar a página
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Mostra um indicador de carregamento
                const syncBtn = document.getElementById('syncGoogleBtn');
                const originalText = syncBtn.innerHTML;
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sincronizando...';
                
                // Troca o código por um token de acesso
                const tokenResponse = await exchangeCodeForToken(code);
                
                if (tokenResponse.access_token) {
                    // Armazena o token para uso futuro
                    localStorage.setItem('google_access_token', tokenResponse.access_token);
                    if (tokenResponse.refresh_token) {
                        localStorage.setItem('google_refresh_token', tokenResponse.refresh_token);
                    }
                    
                    // Busca os contatos
                    await fetchGoogleContacts(tokenResponse.access_token);
                }
                
            } catch (error) {
                console.error('Erro na autenticação:', error);
                alert('Erro ao autenticar com o Google. Por favor, tente novamente.');
            } finally {
                // Restaura o botão
                if (syncBtn) {
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = originalText;
                }
            }
        }
    }
    
    // Função para trocar o código de autorização por um token de acesso
    async function exchangeCodeForToken(code) {
        const clientId = 'SEU_CLIENT_ID_GOOGLE';
        const clientSecret = 'SUA_CHAVE_SECRETA_CLIENTE';
        const redirectUri = window.location.origin + window.location.pathname;
        
        const tokenUrl = 'https://oauth2.googleapis.com/token';
        
        try {
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    code: code,
                    client_id: clientId,
                    client_secret: clientSecret,
                    redirect_uri: redirectUri,
                    grant_type: 'authorization_code'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error_description || 'Falha na autenticação');
            }
            
            return await response.json();
            
        } catch (error) {
            console.error('Erro ao trocar código por token:', error);
            throw error;
        }
    }
    
    async function fetchGoogleContacts(accessToken) {
        try {
            // Mostra um indicador de carregamento
            const syncBtn = document.getElementById('syncGoogleBtn');
            const originalText = syncBtn ? syncBtn.innerHTML : '';
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando contatos...';
            }
            
            let allGoogleContacts = [];
            let nextPageToken = null;
            
            // Busca os contatos em lotes (páginas)
            do {
                let url = 'https://people.googleapis.com/v1/people/me/connections?' +
                         'personFields=names,emailAddresses,phoneNumbers&pageSize=1000';
                
                if (nextPageToken) {
                    url += `&pageToken=${encodeURIComponent(nextPageToken)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    // Se o token expirou, tenta renovar
                    if (response.status === 401) {
                        const newToken = await refreshAccessToken();
                        if (newToken) {
                            return fetchGoogleContacts(newToken);
                        }
                    }
                    throw new Error('Erro ao buscar contatos');
                }
                
                const data = await response.json();
                allGoogleContacts = [...allGoogleContacts, ...(data.connections || [])];
                nextPageToken = data.nextPageToken;
                
            } while (nextPageToken);
            
            // Processa os contatos do Google
            const newContacts = [];
            let importedCount = 0;
            let updatedCount = 0;
            
            // Cria um mapa de contatos existentes por telefone para busca mais rápida
            const existingContactsMap = {};
            allContacts.forEach(contact => {
                existingContactsMap[contact.phone] = contact;
            });
            
            allGoogleContacts.forEach(contact => {
                const name = contact.names?.[0]?.displayName || 'Sem nome';
                const email = contact.emailAddresses?.[0]?.value || '';
                const phone = contact.phoneNumbers?.[0]?.canonicalForm || '';
                const formattedPhone = phone.replace(/\D/g, '');
                
                if (formattedPhone) {
                    // Verifica se o contato já existe
                    const existingContact = existingContactsMap[formattedPhone];
                    
                    if (!existingContact) {
                        // Adiciona novo contato
                        newContacts.push({
                            id: Date.now() + Math.random(),
                            name,
                            phone: formattedPhone,
                            email,
                            type: 'cliente',
                            createdAt: new Date().toISOString().split('T')[0],
                            source: 'google',
                            lastSynced: new Date().toISOString()
                        });
                        importedCount++;
                    } else if (existingContact.source === 'google') {
                        // Atualiza contato existente se necessário
                        const needsUpdate = 
                            existingContact.name !== name || 
                            (email && existingContact.email !== email);
                            
                        if (needsUpdate) {
                            existingContact.name = name;
                            existingContact.email = email || existingContact.email;
                            existingContact.lastSynced = new Date().toISOString();
                            updatedCount++;
                        }
                    }
                }
            });
            
            // Adiciona os novos contatos
            if (newContacts.length > 0) {
                allContacts = [...allContacts, ...newContacts];
            }
            
            // Atualiza a lista
            filterContacts();
            
            // Mostra mensagem de sucesso
            let message = '';
            if (importedCount > 0) {
                message += `Foram importados ${importedCount} novos contatos. `;
            }
            if (updatedCount > 0) {
                message += `${updatedCount} contatos foram atualizados.`;
            }
            if (importedCount === 0 && updatedCount === 0) {
                message = 'Nenhum novo contato encontrado no Google ou todos já estavam sincronizados.';
            }
            
            alert(message);
            
        } catch (error) {
            console.error('Erro ao importar contatos do Google:', error);
            
            // Remove o token inválido
            if (error.message.includes('401')) {
                localStorage.removeItem('google_access_token');
                localStorage.removeItem('google_refresh_token');
            }
            
            alert(`Erro ao importar contatos do Google: ${error.message}`);
            
        } finally {
            // Restaura o botão
            const syncBtn = document.getElementById('syncGoogleBtn');
            if (syncBtn) {
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText || '<i class="fab fa-google me-1"></i>Google';
            }
        }
    }
    
    function processCSVData(csvData) {
        const progress = document.getElementById('importProgress');
        const progressBar = progress.querySelector('.progress-bar');
        
        try {
            // Processa o CSV linha por linha
            const lines = csvData.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            // Verifica se o cabeçalho está correto
            const isValidHeader = CSV_HEADERS.every(header => headers.includes(header));
            if (!isValidHeader) {
                throw new Error('Formato de arquivo inválido. Certifique-se de que o arquivo contenha as colunas: Nome, Telefone, E-mail');
            }
            
            let importedCount = 0;
            let totalLines = lines.length - 1; // Desconta o cabeçalho
            
            // Processa cada linha do CSV
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const contact = {};
                
                // Mapeia os valores para as colunas corretas
                headers.forEach((header, index) => {
                    contact[header] = values[index] || '';
                });
                
                // Formata o telefone (remove caracteres não numéricos)
                const phone = contact.telefone.replace(/\D/g, '');
                if (!phone) continue;
                
                // Verifica se o contato já existe
                const exists = allContacts.some(c => c.phone === phone);
                if (!exists) {
                    allContacts.push({
                        id: Date.now() + i,
                        name: contact.nome,
                        phone: phone,
                        email: contact.email || '',
                        type: 'cliente',
                        createdAt: new Date().toISOString().split('T')[0],
                        source: 'csv'
                    });
                    importedCount++;
                }
                
                // Atualiza a barra de progresso
                const progressPercent = Math.round((i / totalLines) * 100);
                progressBar.style.width = `${progressPercent}%`;
                progressBar.setAttribute('aria-valuenow', progressPercent);
            }
            
            // Atualiza a lista de contatos
            filterContacts();
            
            // Fecha o modal e mostra mensagem de sucesso
            const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
            modal.hide();
            
            if (importedCount > 0) {
                alert(`Foram importados ${importedCount} novos contatos.`);
            } else {
                alert('Nenhum novo contato foi importado. Verifique se os contatos já não estavam cadastrados.');
            }
            
        } catch (error) {
            console.error('Erro ao processar o arquivo CSV:', error);
            alert(`Erro ao importar contatos: ${error.message}`);
        } finally {
            progress.style.display = 'none';
        }
    }
    
    // Função para renovar o token de acesso usando o refresh token
    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('google_refresh_token');
        if (!refreshToken) return null;
        
        try {
            const clientId = 'SEU_CLIENT_ID_GOOGLE';
            const clientSecret = 'SUA_CHAVE_SECRETA_CLIENTE';
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    client_id: clientId,
                    client_secret: clientSecret,
                    refresh_token: refreshToken,
                    grant_type: 'refresh_token'
                })
            });
            
            if (!response.ok) {
                throw new Error('Falha ao renovar o token de acesso');
            }
            
            const tokenData = await response.json();
            
            // Atualiza o token de acesso
            localStorage.setItem('google_access_token', tokenData.access_token);
            
            // Se um novo refresh token foi fornecido, armazena-o também
            if (tokenData.refresh_token) {
                localStorage.setItem('google_refresh_token', tokenData.refresh_token);
            }
            
            return tokenData.access_token;
            
        } catch (error) {
            console.error('Erro ao renovar token:', error);
            // Remove os tokens inválidos
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_refresh_token');
            return null;
        }
    }
    
    // Função para sincronizar contatos do WhatsApp
    async function syncWhatsAppContacts() {
        const syncBtn = document.getElementById('syncWhatsAppBtn');
        const originalText = syncBtn.innerHTML;
        
        try {
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
            // Simulando uma chamada para a API do WhatsApp
            // Na implementação real, você precisará usar a API oficial do WhatsApp Business
            const whatsappContacts = await fetchWhatsAppContacts();
            
            let importedCount = 0;
            let updatedCount = 0;
            
            // Processa os contatos do WhatsApp
            whatsappContacts.forEach(contact => {
                const phone = contact.phone.replace(/\D/g, '');
                const existsIndex = allContacts.findIndex(c => c.phone === phone);
                
                if (existsIndex === -1) {
                    // Adiciona novo contato
                    allContacts.push({
                        id: Date.now() + Math.random(),
                        name: contact.name || `Contato (${phone})`,
                        phone: phone,
                        type: 'cliente',
                        source: 'whatsapp',
                        lastSynced: new Date().toISOString()
                    });
                    importedCount++;
                } else if (allContacts[existsIndex].source === 'whatsapp') {
                    // Atualiza contato existente
                    if (contact.name && allContacts[existsIndex].name !== contact.name) {
                        allContacts[existsIndex].name = contact.name;
                        updatedCount++;
                    }
                    allContacts[existsIndex].lastSynced = new Date().toISOString();
                }
            });
            
            // Atualiza a lista
            filterContacts();
            
            // Mostra mensagem de sucesso
            let message = '';
            if (importedCount > 0) message += `Foram importados ${importedCount} novos contatos. `;
            if (updatedCount > 0) message += `${updatedCount} contatos foram atualizados.`;
            if (!importedCount && !updatedCount) message = 'Nenhum novo contato encontrado no WhatsApp.';
            
            alert(message);
            
        } catch (error) {
            console.error('Erro ao sincronizar contatos do WhatsApp:', error);
            alert('Erro ao sincronizar contatos do WhatsApp: ' + error.message);
        } finally {
            syncBtn.disabled = false;
            syncBtn.innerHTML = originalText;
        }
    }
    
    // Função simulada para buscar contatos do WhatsApp
    // Em um ambiente real, você usaria a API oficial do WhatsApp Business
    async function fetchWhatsAppContacts() {
        // Simulando uma chamada de API com timeout
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Retorna uma lista simulada de contatos
        // Na implementação real, você usaria a API do WhatsApp
        return [
            { phone: '5511999991111', name: 'João Silva' },
            { phone: '5511999992222', name: 'Maria Santos' },
            // Adicione mais contatos de exemplo ou use a API real aqui
        ];
    }
    
    // Verifica se há um código de autorização na URL ao carregar a página
    window.addEventListener('load', function() {
        // Processa o código de autorização se estiver na URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code')) {
            processGoogleAuth();
        }
        
        // Verifica se o token está prestes a expirar (opcional)
        const tokenExpiry = localStorage.getItem('google_token_expiry');
        if (tokenExpiry && new Date(tokenExpiry) < new Date(Date.now() + 5 * 60 * 1000)) {
            // Renova o token se estiver prestes a expirar (nos próximos 5 minutos)
            refreshAccessToken();
        }
    });
    </script>
        <!-- Bootstrap Bundle JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Menu Manager (se existir) -->
        <script src="js/menu-manager.js"></script>
        <script>
            // Inicialização do menu responsivo (igual index.html)
            document.addEventListener('DOMContentLoaded', function() {
                const sidebarToggle = document.getElementById('sidebarToggle');
                const sidebar = document.querySelector('.sidebar');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', function() {
                        document.body.classList.toggle('sidebar-collapsed');
                        localStorage.setItem('sidebarCollapsed', document.body.classList.contains('sidebar-collapsed'));
                    });
                }
                if (localStorage.getItem('sidebarCollapsed') === 'true') {
                    document.body.classList.add('sidebar-collapsed');
                }
                const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
                dropdownToggles.forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        const submenu = this.nextElementSibling;
                        submenu.classList.toggle('show');
                        this.setAttribute('aria-expanded', 
                            this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
                    });
                });
            });
        </script>
    </body>
</html>
